<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>首页</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no">
    <link rel="stylesheet" href="css/style.min.css">
    <script src="js/jquery-2.1.3.min.js"></script>
    <script src="js/jquery.session.js"></script>
    <script src="js/common.min.js"></script>
    <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript" src="plugins/cordova-plugin-bluetoothle/www/bluetoothle.js"></script>
       <script src="js/bluetooth.js"></script>
    <script>
        function bluetoothDisconver(printSuc, address) {

            }
            function connectSuccess(rpsuc) {
                if (rpsuc.status == "connected") {
                    alert("连接成功！");
                   SetCache("bluetootheAddress", rpsuc.address);
                   var url=$.session.get("url");
                   if(!url){
                     url="qrcode.html";
                   }
                    document.location = url;
                    //bluetoothle.discover(function(sucs){
                              //     bluetoothle.writeTitle(function(aa){alert(aa);}
                                 //  ,function(err){alert("错误："+err.message)}
                                 //  ,{value:"aaaaa",address:rpsuc.address,number:"B203",prevNumber:"23",type:"非预约",shopName:"北京华誉维诚哈尔滨店",type:"预约"})
                       // },function(err){alert("错误："+err.message)},{address:rpsuc.address});
                    return;
                } else {
                    alert("连接失败，请重启蓝牙尝试！");
                }
            }
            function onconnect(address) {
                //stop scan the bluetooth
                bluetoothle.stopScan(function (rpsu) { }, function (err) { });
                bluetoothle.connect(connectSuccess, function (rerr) {

                    bluetoothle.isConnected(function (scc) {
                        if (!scc.isConnected) {
                            alert("连接失败，请重启蓝牙尝试！");
                        } else {
                            alert("连接成功!");
                              SetCache("bluetootheAddress", scc.address, false);
                           // document.location = document.referrer;
                           // bluetoothle.discover(function(sucs){
                                 //  bluetoothle.writeTitle(function(aa){alert(aa);},function(err){alert(err.message)},{value:"aaaaa",address:sucs.address,number:"B203",prevNumber:"23",type:"非预约",shopName:"北京华誉维诚哈尔滨店",type:"预约"})
                        
                        
                   // }, function (err) { alert(err.message) }, { "address": address });
                        }
                        }, function (err) { alert(err.message) },{ "address": address });
                }, { "address": address });


            }
            $(function () {
                $(".header-right").html("华誉维诚—" + $.session.get("shopname"));

                var deviceArray = [];
                var app = {
                    // Application Constructor
                    initialize: function () {
                        this.bindEvents();
                    },
                    // Bind Event Listeners
                    //
                    // Bind any events that are required on startup. Common events are:
                    // 'load', 'deviceready', 'offline', and 'online'.
                    bindEvents: function () {
                        document.addEventListener('deviceready', this.onDeviceReady, false);
                    },
                    // deviceready Event Handler
                    //
                    // The scope of 'this' is the event. In order to call the 'receivedEvent'
                    // function, we must explicitly call 'app.receivedEvent(...);'
                    onDeviceReady: function () {
                        app.receivedEvent('deviceready');
                    },
                    // Update DOM on a Received Event
                    receivedEvent: function (id) {

                        bluetoothle.initialize(function (rpStatus) {
                                             
                            if (rpStatus.status == "enabled") {
                                //扫描蓝牙
                                             
                                bluetoothle.startScan(app.bluetoothScan, function (err) { }, {});
                            }
                        },
                            {
                                "request": true,
                                "statusReceiver": true
                            });
                    },
                    bluetoothScan: function (scanDevice) {
                        if (scanDevice.name && scanDevice.name != null && scanDevice.address && scanDevice.address != null) {
                            var isHav = false;
                            for (var i = 0; i < deviceArray.length; i++) {
                                var device = deviceArray[i];
                                if (device.address == scanDevice.address) {
                                    isHav = true;
                                    break;
                                }
                            }
                            if (!isHav) {
                                deviceArray.push({ name: scanDevice.name, address: scanDevice.address });
                                $(".bluetooth-list").append("<li onclick=onconnect('" + scanDevice.address + "')>" + scanDevice.name + "---" + scanDevice.address + "</li>");
                            }
                        }
                    }
                };
                app.initialize();

            });
    </script>
</head>

<body>
    <header>
        <h1>蓝牙配置</h1>
        <a class="header-right" href="javascript:;"></a>
    </header>
    <div class="bluetooth">
        <ul class="bluetooth-list">

        </ul>
    </div>
    <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript" src="plugins/cordova-plugin-bluetoothle/www/bluetoothle.js"></script>
    <script type="text/javascript" src="js/jquery-1.12.0.min.js"></script>
</body>

</html>